<?php

/**
 * Implements hook_menu().
 */
function export_settings_menu() {
  $items['admin/config/system/export_settings'] = array(
    'title' => 'Export site settings',
    'description' => t('Export settings'),
    'page callback' => 'export_settings_page',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

function export_settings_page() {
  $form = drupal_get_form('export_settings_vars_form');
  $form = drupal_render($form);
  return $form;
}

function export_settings_vars_form($form, &$form_state) {
  $form = array();

  $form['module_name'] = array(
    '#type' => 'textfield',
    '#title' => t('Module name'),
    '#default_falue' => 'my_module',
    '#size' => 60,
    '#maxlength' => 128,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Generate module'),
  );

  include_once DRUPAL_ROOT . '/includes/utility.inc';
  global $conf;
  foreach ($conf as $key => $value) {
    if (is_array($value)) {
      $value = '<pre>' . drupal_var_export($value) . '</pre>';
    }
    $vars[] = array('id' => $key, 'value_name' => $key, 'variable' => $value);
  }

  $header = array(
    'value_name' => t('Value Name'),
    'variable' => t('Variable'),
  );
  $options = array();
  foreach ($vars as $var) {
    $options[$var['id']] = array(
      'value_name' => $var['value_name'],
      'variable' => $var['variable'],
    );
  }
  $form['table'] = array(
    '#type' => 'tableselect',
    '#header' => $header,
    '#options' => $options,
    '#empty' => t('No variables found'),
  );

  return $form;
}

function export_settings_vars_form_submit($form, &$form_state) {
  $module_code = '';
  foreach ($form_state['values']['table'] as $selected_item) {
    if ($selected_item) {
      $variable = variable_get($selected_item);
      if (is_array($variable)) {
        $variable = drupal_var_export($variable);
      }
      $module_code .= "  variable_set('$selected_item', '$variable');\n";
    }
  }
  if ($module_code) {
    $module_name = $form_state['values']['module_name'] == '' ? 'my_module' : $form_state['values']['module_name'];
    $module_code = '<?php

/**
* Implements hook_enable().
*/
' . $module_name . '_enable() {
' . $module_code . '}';

    dsm($module_code);

    header('Cache-Control: must-revalidate, post-check=0, pre-check=0');
    header('Content-Type: text/module');
    header('Content-Disposition: attachment; filename="my_module.module"');
    // die(print $module_code);
  }
}

function vars_to_html($vars) {
  include_once DRUPAL_ROOT . '/includes/utility.inc';
  $res = '<table><tbody>';
  foreach ($vars as $key => $value) {
    $res .= '<tr>';
    $res .= '<td>' . $key . '</td>';
    if (is_array($value)) {
      $value = '<pre>' . drupal_var_export($value) . '</pre>';
    }
    $res .= '<td>' . $value . '</td>';
    $res .= '</tr>';
  }
  $res .= '</tbody></table>';
  return $res;
}

function recurseTree($var) {
  $out = '<li>';
  foreach ($var as $v) {
    if (is_array($v)) {
      $out .= '<ul>' . recurseTree($v) . '</ul>';
    }
    else {
      $out .= $v;
    }
  }
  return $out . '</li>';
}

